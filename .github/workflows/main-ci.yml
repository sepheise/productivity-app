name: main-ci
on: 
  push:
    branches:
      - 'setup-ci'
jobs:
  test:
    runs-on: macos-12
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -project ProductivityFW/ProductivityFW.xcodeproj \
            -scheme CI CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO
      - name: Save build status
        run: echo "BUILD_STATUS=${{ job.status }}" >> $GITHUB_ENV
      - name: Creates build status badge
        uses: schneegans/dynamic-badges-action@v1.4.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: e6b6d639ed2a33d1d08b84237724ebe9
          filename: productivity-app-build-status.json
          label: Build
          message: ${{ env.BUILD_STATUS == 'success' && 'passing' || 'failing' }}
          color: green
          isError: ${{ env.BUILD_STATUS != 'success' }}
      - name: Run CI scheme Tests
        run: |
          xcodebuild test \
            -project ProductivityFW/ProductivityFW.xcodeproj \
            -scheme CI CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO \
            -resultBundlePath build/ResultBundle.xcresult
      - name: Save test status
        run: echo "TEST_STATUS=${{ job.status }}" >> $GITHUB_ENV
      - name: Creates test status badge
        uses: schneegans/dynamic-badges-action@v1.4.0
        with:
          auth: ${{ secrets.GIST_SECRET }}
          gistID: f766cc76b47b16757b8d724d198ddd52
          filename: productivity-app-test-status.json
          label: Test
          message: ${{ env.TEST_STATUS == 'success' && 'passing' || 'failing' }}
          color: green
          isError: ${{ env.TEST_STATUS != 'success' }}
  update-badges:
    runs-on: ubuntu-latest
    needs: test
    steps:
      - run: echo "Build status is ${{ env.BUILD_STATUS }}"
      - run: echo "Test status is ${{ env.TEST_STATUS }}"
